#!/bin/bash
TMP_DIR=/tmp/rg-fzf
mkdir -p "$TMP_DIR" 

PID=$$
frf_f="$TMP_DIR/frf_f_$PID"
frf_r="$TMP_DIR/frf_r_$PID"

frf_max_depth="${1:-1000}"
# $2 can be set to "-tmux", and options, to open frf in fzf-tmux
# $3 controls if option --expect=ctrl-t is used or not
# $4 is the rg filter, see frl and frg

[[ "$4" ]] && \
	{
	rg_filter="$4"
	previewer='{ [[ -e {} ]] && { rg -C1 -n --smart-case --color=always --colors "match:fg:51" {q} {} || { file {} | piper "[^,]+" "grey20" ",.*" "grey10" ; } ; } ; }' 
	} || \
	{
	rg_filter=frl
	previewer='{ perl -e "exit -B \$ARGV[0]" -- {} && tvcat {} 100 || { file {} | piper "[^,]+" "grey20" ",.*" "grey10" ; } ; }'
	}

FZF_DEFAULT_COMMAND="$rg_filter '' $frf_max_depth" fzf$2 \
	-e \
	-m \
	--cycle \
	--disabled \
	--no-sort \
	--ansi \
	--layout=reverse \
	--info=inline \
	--color="hl:51,header:238,bg+:236" \
	--prompt '1. rg> ' \
	--header '^rg ^fzf ᵃj-down ᵃk-up ?-preview ^select ^deselect ^toggle ^p-size' \
	--bind "change:reload:sleep 0.1; $rg_filter {q} $frf_max_depth || true" \
	--bind "ctrl-f:unbind(change,ctrl-f)+change-prompt(2. fzf> )+enable-search+rebind(ctrl-r)+transform-query(echo {q} >$frf_r; cat $frf_f)" \
	--bind "ctrl-r:unbind(ctrl-r)+change-prompt(1. rg> )+disable-search+reload($rg_filter {q} $frf_max_depth || true)+rebind(change,ctrl-f)+transform-query(echo {q} >$frf_f; cat $frf_r)" \
	--bind 'alt-k:preview-up,alt-j:preview-down' \
	--bind '?:toggle-preview' \
	--bind 'ctrl-s:select-all,ctrl-d:deselect-all' \
	$([[ -n $3 ]] && echo "--expect=ctrl-t") \
	--bind 'ctrl-p:change-preview-window(75%|right,up|50%,hidden|right)' \
	--preview-window='right:60%' \
	--preview "[[ -d {} ]] && ls -AgGh --group-directories-first --color=always {} || $previewer"

